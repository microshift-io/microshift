name: prebuild-environment-setup
description: Reusable action to configure the build environment for MicroShift

runs:
  using: "composite"
  steps:
    - name: Prepare the build and run environment
      shell: bash
      run: |
        set -euo pipefail
        set -x

        # Attempt to clean up any pre-existing files on the /mnt partition to
        # conserve disk space. Note that this is a best-effort approach and
        # not all files may be removed (e.g. swapfile, etc.).
        sudo rm -rvf /mnt/* || true

        # Create the necessary directories on the /mnt partition
        sudo mkdir -p /mnt/tmp /mnt/rpms /mnt/release
        sudo chmod 1777 /mnt/tmp

        # Install the pre-requisites for the build and run environment
        sudo apt-get update  -y -q
        sudo apt-get install -y -q make lvm2 podman jq curl

        # Install the latest OpenShift client from the OpenShift Mirror
        ocp_client="openshift-client-linux-amd64-rhel9.tar.gz"
        if [ "$(uname -m)" == "aarch64" ] ; then
          ocp_client="openshift-client-linux-arm64-rhel9.tar.gz"
        fi
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/${ocp_client} -o /tmp/${ocp_client}
        sudo tar xvf /tmp/${ocp_client} -C /usr/bin
        rm -f /tmp/${ocp_client}

        # Redirect the container build directories to /mnt/ to avoid running out of disk space.
        sudo mv /var/tmp /var/tmp.orig
        sudo mv /var/lib/containers /mnt/containers
        sudo ln -s /mnt/tmp /var/tmp
        sudo ln -s /mnt/containers /var/lib/containers
