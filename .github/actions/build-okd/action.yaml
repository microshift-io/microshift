name: build-okd-images
description: Reusable action to build OKD images

inputs:
  ushift-branch:
    description: MicroShift branch from https://github.com/openshift/microshift/branches
    required: true
    type: string
  okd-version-tag:
    description: OKD version tag from https://quay.io/repository/okd/scos-release?tab=tags
    required: true
    type: string
  bootc-image-url:
    description: Base Bootc image URL used in `make image` command
    required: false
    default: quay.io/centos-bootc/centos-bootc
    type: string
  bootc-image-tag:
    description: Base Bootc image tag used in `make image` command
    required: false
    default: stream9
    type: string
  target-arch:
    description: Target architecture for the OKD images
    required: true
    type: string
  target-registry:
    description: Target registry for the OKD images
    required: true
    type: string
  token:
    description: Token for the GitHub Container Registry
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Detect the CPU architecture
      id: detect-cpu-arch
      uses: ./.github/actions/arch

    - name: Collect debug information before the build
      if: always()
      uses: ./.github/actions/debug-info

    - name: Prepare the build and run environment
      uses: ./.github/actions/prebuild

    - name: Login to GitHub Container Registry
      uses: ./.github/actions/podman-login
      with:
        token: ${{ inputs.token }}

    - name: Build OKD images
      shell: bash
      run: |
        set -euo pipefail

        cd ${GITHUB_WORKSPACE}/
        TARGET_REGISTRY="${{ inputs.target-registry }}" ./src/okd/build_images.sh \
          "${{ inputs.okd-version-tag }}" \
          "${{ inputs.ushift-branch }}" \
          "${{ inputs.target-arch }}"

    - name: Build MicroShift RPMs
      shell: bash
      run: |
        # See https://github.com/microshift-io/microshift/blob/main/docs/build.md
        # for more information about the build process.

        # Run the RPM build process.
        cd ${GITHUB_WORKSPACE}/
        make rpm \
          USHIFT_BRANCH=${{ inputs.ushift-branch }} \
          OKD_VERSION_TAG=${{ inputs.okd-version-tag }} \
          OKD_REPO=${{ inputs.okd-repo }}/okd-release-${{ steps.detect-cpu-arch.outputs.go_arch }}
          RPM_OUTDIR=/mnt/rpms

    - name: Build MicroShift bootc container image
      if: contains(fromJSON('["all", "bootc-image"]'), inputs.build)
      shell: bash
      run: |
        # See https://github.com/microshift-io/microshift/blob/main/docs/build.md
        # for more information about the build process.

        # Run the container image build process.
        cd ${GITHUB_WORKSPACE}/

        make image \
          BOOTC_IMAGE_URL=${{ inputs.bootc-image-url }} \
          BOOTC_IMAGE_TAG=${{ inputs.bootc-image-tag }} \

    - name: Run a test to verify that MicroShift is functioning properly
      if: contains(fromJSON('["all", "bootc-image"]'), inputs.build)
      shell: bash
      run: |
        # See https://github.com/microshift-io/microshift/blob/main/docs/run.md
        # for more information about the run process.

        # Run the MicroShift container
        make run

        # Start-stop test with readiness check
        make run-ready
        make run-healthy
        make stop

    # Uncomment this to enable tmate-debug on failure
    # - name: Pause and open tmate debug session
    #   if: failure()
    #   uses: ./.github/actions/tmate-debug

    - name: Collect debug information after the build
      if: always()
      uses: ./.github/actions/debug-info
